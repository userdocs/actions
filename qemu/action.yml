name: QEMU User Static Installer
description: Installs QEMU user-mode static emulation for cross-compilation. Automatically skips installation when target architecture matches host to optimize build times.
branding:
  icon: cpu
  color: blue
inputs:
  distinct_id:
    description: "Unique identifier for the action instance (currently unused)"
    required: false
    default: ""
  target_arch:
    description: "Target architecture for cross-compilation (e.g., amd64, arm64, armv7, i386). Used to determine if QEMU emulation is needed."
    required: false
    default: ""
outputs:
  skip_qemu:
    description: "Set to 'true' when QEMU installation was skipped because target matches host architecture"
    value: ${{ steps.qemu_check.outputs.skip_qemu }}
  qemu_target:
    description: "The target architecture that QEMU will emulate"
    value: ${{ steps.qemu_check.outputs.qemu_target }}
runs:
  using: "composite"
  steps:
    
    - name: determine host and target combination.
      id: qemu_check
      shell: bash
      env:
        runner_arch: ${{ runner.arch }}
        guess_the_arch: ${{ inputs.target_arch }}
      run: |
        # Functions for consistent logging
        log_info() {
          printf '[INFO] %s\n' "$1"
        }

        log_error() {
          printf '[ERROR] %s\n' "$1" >&2
        }

        log_debug() {
          printf '[DEBUG] %s\n' "$1"
        }

        to_gh_env() {
          for kv in "$@"; do
            case $kv in
              *=*)
                key=${kv%%=*}   # part before '='
                val=${kv#*=}    # part after '='
                printf -v "$key" '%s' "$val"
                ;;
            esac
          done
          printf '%s\n' "${1}" | tee -a "$GITHUB_ENV"
        }

        to_gh_output() {
          printf '%s\n' "${1}" | tee -a "$GITHUB_OUTPUT"
        }

        log_summary() {
          printf '%b\n' '```bash' | tee -a "$GITHUB_STEP_SUMMARY"
          printf '%b\n' "${1}" | tee -a "$GITHUB_STEP_SUMMARY"
          printf '%b\n' '```' | tee -a "$GITHUB_STEP_SUMMARY"
        }

        unset skip_qemu

        case "${runner_arch}" in
          X86 | X64)
            if [[ ${guess_the_arch} =~ ^((default|amd64|x86|i386|i586|i686).*)$ ]]; then
              to_gh_env "skip_qemu=true"
              to_gh_output "skip_qemu=true"
              log_summary skip_qemu=true
            fi
            ;;
          ARM | ARM64)
            if [[ ${guess_the_arch} =~ ^((default|aarch64|arm).*)$ ]]; then
              to_gh_env "skip_qemu=true"
              to_gh_output "skip_qemu=true"
              log_summary skip_qemu=true
            fi
            ;;
        esac

        if [[ -z $skip_qemu ]]; then
          log_summary "host_arch=${runner_arch}"
          log_summary "qemu_target=${guess_the_arch}"
          to_gh_env "qemu_target=${guess_the_arch}"
          to_gh_output "qemu_target=${guess_the_arch}"
        fi

    - name: Update apt cache
      if: env.skip_qemu != 'true'
      shell: bash
      run: sudo apt-get update

    - name: Install qemu user static
      if: env.skip_qemu != 'true'
      shell: bash
      run: sudo apt-get install -y libpipeline1 qemu-user-static binfmt-support